<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-error/src/index.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#error-handler">Error handler</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#install-error-handler">Install error handler</a>
      </div>

      <div class="heading h3">
        <a href="#process-uncaught-error">Process uncaught error</a>
      </div>

      <div class="heading h2">
        <a href="#report-error">Report error</a>
      </div>

      <div class="heading h2">
        <a href="#format-error">Format error</a>
      </div>

      <div class="heading h3">
        <a href="#recursive-part-to-format-errors-with-cause">Recursive part to format errors with cause</a>
      </div>

      <div class="heading h2">
        <a href="#helper-methods">Helper methods</a>
      </div>

      <div class="heading h3">
        <a href="#overwrite-internal-stack-trace-formatting">Overwrite internal stack trace formatting</a>
      </div>

      <div class="heading h3">
        <a href="#retrieve-highlighted-code-display">Retrieve highlighted code display</a>
      </div>

      <div class="heading h3">
        <a href="#get-the-mapped-frame">Get the mapped frame</a>
      </div>

      <div class="heading h3">
        <a href="#find-the-mapped-position">Find the mapped position</a>
      </div>

      <div class="heading h3">
        <a href="#get-the-sourcemap-data">Get the sourcemap data</a>
      </div>

      <div class="heading h3">
        <a href="#retrieve-file-for-node-and-browser">Retrieve file for node and browser</a>
      </div>

      <div class="heading h3">
        <a href="#make-path-absolute">Make path absolute</a>
      </div>

      <div class="heading h3">
        <a href="#get-eval-origin">get eval origin</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-error.git" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="error-handler">
  <h1>
    <a href="#error-handler" name="error-handler" class="pilcrow"></a>
Error handler
  </h1>
</div>
<p>The error handling will only work if run through node.js not if called
directly using iced or coffee. If interpreting coffee directly it will
not always capture the errors using <code>process.on 'uncaughtException'</code>.
That's a bug in the coffee interpreter implementation. Instead of this module
then the default behavior will be used.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
sourcemap = <span class="hljs-built_in">require</span> <span class="hljs-string">'source-map'</span>
sprintf = <span class="hljs-built_in">require</span>(<span class="hljs-string">"sprintf-js"</span>).sprintf
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.config =
  <span class="hljs-attribute">colors</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">properties</span>: <span class="hljs-literal">true</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Define whether and which stack lines to show</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">stack</span>:
    <span class="hljs-attribute">view</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">modules</span>: <span class="hljs-literal">false</span>
    <span class="hljs-attribute">system</span>: <span class="hljs-literal">false</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Define if and how much code to show</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">code</span>:
    <span class="hljs-attribute">view</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">before</span>: <span class="hljs-number">2</span>
    <span class="hljs-attribute">after</span>: <span class="hljs-number">2</span>
    <span class="hljs-attribute">compiled</span>: <span class="hljs-literal">false</span>
    <span class="hljs-attribute">all</span>: <span class="hljs-literal">false</span>
    <span class="hljs-attribute">modules</span>: <span class="hljs-literal">false</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Display of the errors cause if there is one</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">cause</span>:
    <span class="hljs-attribute">view</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">stack</span>: <span class="hljs-literal">true</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Should command exit after an uncaught error is reported</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">uncaught</span>:
    <span class="hljs-attribute">exit</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">timeout</span>: <span class="hljs-number">1000</span>
    <span class="hljs-attribute">code</span>: -<span class="hljs-number">1</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>define a specific logger</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">logger</span>: <span class="hljs-built_in">console</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="install-error-handler">
  <h2>
    <a href="#install-error-handler" name="install-error-handler" class="pilcrow"></a>
Install error handler
  </h2>
</div>
<p>Install the error handler for uncaught Errors</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">install</span> = -&gt;</span>
  Error.prepareStackTrace = prepareStackTrace
  process.<span class="hljs-literal">on</span> <span class="hljs-string">'uncaughtException'</span>, uncaughtError
  <span class="hljs-built_in">module</span>.exports


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="process-uncaught-error">
  <h3>
    <a href="#process-uncaught-error" name="process-uncaught-error" class="pilcrow"></a>
Process uncaught error
  </h3>
</div>
<p>The error will be caught, reported (colorful) and then the process will be
stopped with exit value 2 if defined.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>err</code>
Error object instance to report.</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">uncaughtError</span> = <span class="hljs-params">(err)</span> -&gt;</span>
  config = <span class="hljs-built_in">module</span>.exports.config
  <span class="hljs-built_in">module</span>.exports.report err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>stop processing after short timeout to finish logging</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> config.uncaught.exit
    setTimeout -&gt;
      <span class="hljs-built_in">console</span>.error chalk.yellow <span class="hljs-string">"Exiting after error logging timeout."</span>
      process.exit err.code ? config.uncaught.code
    , config.uncaught.timeout


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="report-error">
  <h2>
    <a href="#report-error" name="report-error" class="pilcrow"></a>
Report error
  </h2>
</div>
<p>The given error will be reported to error output like configured. This may
be colorful with stack trace, source mapping and code view.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>err</code>
Error object instance to report.</li>
<li><code>level</code>
Log level to use, must correspond with a method in logger.</li>
</ul>
<p>This may use any specified logger, which have <code>logger.&lt;level&gt;(&lt;error&gt;)</code> or
a method <code>logger.log(&lt;level&gt;, &lt;error&gt;)</code>.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">report = <span class="hljs-built_in">module</span>.exports.report = <span class="hljs-function"><span class="hljs-params">(err, level = <span class="hljs-string">'error'</span>)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>.exports.config.logger?[level]?
    <span class="hljs-built_in">module</span>.exports.config.logger[level] format err
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>.exports.config.logger?.log?
    <span class="hljs-built_in">module</span>.exports.config.logger.log level, format err
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">console</span>.error format err

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="format-error">
  <h2>
    <a href="#format-error" name="format-error" class="pilcrow"></a>
Format error
  </h2>
</div>
<p>The given error will be formatted as string. This may be colorful with stack
trace, source mapping and code view.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>err</code>
Error object instance to report.</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.format = <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span> format err

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="recursive-part-to-format-errors-with-cause">
  <h3>
    <a href="#recursive-part-to-format-errors-with-cause" name="recursive-part-to-format-errors-with-cause" class="pilcrow"></a>
Recursive part to format errors with cause
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">format</span> = <span class="hljs-params">(err, level, codePart)</span> -&gt;</span>
  config = <span class="hljs-built_in">module</span>.exports.config
  <span class="hljs-keyword">if</span> err <span class="hljs-keyword">instanceof</span> Error
    msg = err.toString()
    msg = <span class="hljs-string">"Caused by <span class="hljs-subst">#{msg}</span>"</span> <span class="hljs-keyword">if</span> level
    msg += <span class="hljs-string">" (<span class="hljs-subst">#{codePart}</span>)"</span> <span class="hljs-keyword">if</span> codePart
    <span class="hljs-keyword">if</span> config.colors
      msg = chalk.bold[<span class="hljs-keyword">if</span> level? <span class="hljs-keyword">then</span> <span class="hljs-string">'magenta'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'red'</span>] msg
    <span class="hljs-keyword">if</span> config.properties
      <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">of</span> err
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> [<span class="hljs-string">'cause'</span>, <span class="hljs-string">'codePart'</span>]
        name = name.charAt(<span class="hljs-number">0</span>).toUpperCase() + name.slice(<span class="hljs-number">1</span>)
        value = util.inspect value <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">isnt</span> <span class="hljs-string">'string'</span>
        msg += <span class="hljs-string">"\n<span class="hljs-subst">#{name}</span>: <span class="hljs-subst">#{value.replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">'\n  '</span>}</span>"</span>
    <span class="hljs-keyword">if</span> config.stack.view <span class="hljs-keyword">and</span> err.stack? <span class="hljs-keyword">and</span> err.stack.match <span class="hljs-regexp">/\n/</span>
      msg += err.stack.replace <span class="hljs-regexp">/.*?\n/</span>, <span class="hljs-string">'\n'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> config.cause.stack <span class="hljs-keyword">and</span> level
      <span class="hljs-keyword">return</span> msg
    <span class="hljs-keyword">if</span> err.cause <span class="hljs-keyword">and</span> config.cause.view
      level ?= <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span> Array.isArray err.cause
        <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> err.cause
          <span class="hljs-keyword">if</span> entry
            cause = format entry, level+<span class="hljs-number">1</span>, err.codePart ? <span class="hljs-literal">null</span>
            msg += <span class="hljs-string">"\n"</span> + cause.split(<span class="hljs-regexp">/\n/</span>).map (l) -&gt;
              l = <span class="hljs-string">"  <span class="hljs-subst">#{l}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.level]
            .join <span class="hljs-string">"\n"</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> err.cause <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span>(err.cause <span class="hljs-keyword">instanceof</span> Error)
        <span class="hljs-keyword">for</span> codePart, entry <span class="hljs-keyword">of</span> err.cause
          cause = format entry, level+<span class="hljs-number">1</span>, codePart ? <span class="hljs-literal">null</span>
          msg += <span class="hljs-string">"\n"</span> + cause.split(<span class="hljs-regexp">/\n/</span>).map (l) -&gt;
            l = <span class="hljs-string">"  <span class="hljs-subst">#{l}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.level]
          .join <span class="hljs-string">"\n"</span>
      <span class="hljs-keyword">else</span>
        cause = format err.cause, level+<span class="hljs-number">1</span>, err.codePart ? <span class="hljs-literal">null</span>
        msg += <span class="hljs-string">"\n"</span> + cause.split(<span class="hljs-regexp">/\n/</span>).map (l) -&gt;
          l = <span class="hljs-string">"  <span class="hljs-subst">#{l}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.level]
        .join <span class="hljs-string">"\n"</span>
  <span class="hljs-keyword">else</span>
    msg = <span class="hljs-string">"Error: <span class="hljs-subst">#{err?.toString()}</span>"</span>
    msg = chalk.bold.red msg <span class="hljs-keyword">if</span> config.colors
  <span class="hljs-keyword">return</span> msg


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-methods">
  <h2>
    <a href="#helper-methods" name="helper-methods" class="pilcrow"></a>
Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="overwrite-internal-stack-trace-formatting">
  <h3>
    <a href="#overwrite-internal-stack-trace-formatting" name="overwrite-internal-stack-trace-formatting" class="pilcrow"></a>
Overwrite internal stack trace formatting
  </h3>
</div>
<p>This function is part of the V8 stack trace API, for more info see:
http://code.google.com/p/v8/wiki/JavaScriptStackTraceApi</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">prepareStackTrace</span> = <span class="hljs-params">(err, stack)</span> -&gt;</span>
  config = <span class="hljs-built_in">module</span>.exports.config
  <span class="hljs-keyword">unless</span> config.stack.view
    stack = stack[.<span class="hljs-number">.1</span>]
  message = err.toString()
  message = chalk.bold.red message <span class="hljs-keyword">if</span> config.colors
  stackline = <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> message + stack.map (frame) -&gt;
    stackline++
    <span class="hljs-keyword">unless</span> config.stack.modules
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> ~frame.getFileName()?.indexOf <span class="hljs-string">'/node_modules/'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span> <span class="hljs-keyword">unless</span> config.stack.system <span class="hljs-keyword">or</span> ~frame.getFileName()?.indexOf <span class="hljs-string">'/'</span>
    map = mapFrame frame
    out = <span class="hljs-string">"\n  at <span class="hljs-subst">#{frame}</span>"</span>
    <span class="hljs-keyword">if</span> (config.code.all <span class="hljs-keyword">or</span> stackline <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> map <span class="hljs-keyword">or</span> config.code.compiled <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>)
      out += getCodeview frame
    <span class="hljs-keyword">if</span> map
      out += <span class="hljs-string">"\n     <span class="hljs-subst">#{map}</span>"</span>
      out += getCodeview map
    <span class="hljs-keyword">return</span> out
  .join <span class="hljs-string">''</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="retrieve-highlighted-code-display">
  <h3>
    <a href="#retrieve-highlighted-code-display" name="retrieve-highlighted-code-display" class="pilcrow"></a>
Retrieve highlighted code display
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">getCodeview</span> = <span class="hljs-params">(frame)</span> -&gt;</span>
  config = <span class="hljs-built_in">module</span>.exports.config
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span> <span class="hljs-keyword">unless</span> config.code.view
  <span class="hljs-keyword">unless</span> config.code.modules
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> ~frame.getFileName()?.indexOf <span class="hljs-string">'/node_modules/'</span>
  contents = retrieveFile frame.getFileName()
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span> <span class="hljs-keyword">unless</span> contents
  lines = contents?.split <span class="hljs-regexp">/(?:\r\n|\n)/</span>
  out = <span class="hljs-string">''</span>
  max = lines.length.toString().length
  num = frame.getLineNumber() - <span class="hljs-number">1</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>lines before</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> config.code.before
    num = num - config.code.before
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>.config.code.before]
      line = sprintf <span class="hljs-string">"\n     %0<span class="hljs-subst">#{max}</span>d: <span class="hljs-subst">#{lines[num++]}</span>"</span>, num
      out += <span class="hljs-keyword">if</span> config.colors <span class="hljs-keyword">then</span> chalk.grey line <span class="hljs-keyword">else</span> line
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>highlight line</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  line = sprintf <span class="hljs-string">"\n     %0<span class="hljs-subst">#{max}</span>d: <span class="hljs-subst">#{lines[num++]}</span>"</span>, num
  <span class="hljs-keyword">if</span> config.colors
    pos = frame.getColumnNumber() + max + <span class="hljs-number">8</span>
    out += chalk.yellow line.slice(<span class="hljs-number">0</span>, pos-<span class="hljs-number">1</span>)
    out += chalk.yellow.underline line.slice(pos-<span class="hljs-number">1</span>, pos+<span class="hljs-number">2</span>)
    out += chalk.yellow line.slice(pos+<span class="hljs-number">2</span>)
  <span class="hljs-keyword">else</span>
    out += line
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>lines after</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> config.code.after
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>.config.code.after]
      line = sprintf <span class="hljs-string">"\n     %0<span class="hljs-subst">#{max}</span>d: <span class="hljs-subst">#{lines[num++]}</span>"</span>, num
      out += <span class="hljs-keyword">if</span> config.colors <span class="hljs-keyword">then</span> chalk.grey line <span class="hljs-keyword">else</span> line
  out

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-the-mapped-frame">
  <h3>
    <a href="#get-the-mapped-frame" name="get-the-mapped-frame" class="pilcrow"></a>
Get the mapped frame
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">mapFrame</span> = <span class="hljs-params">(frame)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Most call sites will return the source file from getFileName(), but code
passed to eval() ending in &quot;//# sourceURL=...&quot; will return the source file
from getScriptNameOrSourceURL() instead</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  source = frame.getFileName() || frame.getScriptNameOrSourceURL()
  <span class="hljs-keyword">if</span> source
    position = mapSourcePosition(
      <span class="hljs-attribute">source</span>: source
      <span class="hljs-attribute">line</span>: frame.getLineNumber()
      <span class="hljs-attribute">column</span>: frame.getColumnNumber()
    )
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">unless</span> position
    <span class="hljs-keyword">return</span> (
      <span class="hljs-attribute">__proto__</span>: frame
      <span class="hljs-attribute">getFileName</span>: <span class="hljs-function">-&gt;</span> position.source
      <span class="hljs-attribute">getLineNumber</span>: <span class="hljs-function">-&gt;</span> position.line
      <span class="hljs-attribute">getColumnNumber</span>: <span class="hljs-function">-&gt;</span> position.column
      <span class="hljs-attribute">getScriptNameOrSourceURL</span>: <span class="hljs-function">-&gt;</span> position.source
    )
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Code called using eval() needs special handling</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origin = frame.isEval() <span class="hljs-keyword">and</span> frame.getEvalOrigin()
  <span class="hljs-keyword">if</span> origin
    origin = mapEvalOrigin(origin)
    <span class="hljs-keyword">return</span> (
      <span class="hljs-attribute">__proto__</span>: frame
      <span class="hljs-attribute">getEvalOrigin</span>: <span class="hljs-function">-&gt;</span>
        origin
    )
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>If we get here then we were unable to change the source position</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-literal">null</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Maps a file path to a source map for that file</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">sourceMapCache = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="find-the-mapped-position">
  <h3>
    <a href="#find-the-mapped-position" name="find-the-mapped-position" class="pilcrow"></a>
Find the mapped position
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">mapSourcePosition</span> = <span class="hljs-params">(position)</span> -&gt;</span>
  sourceMap = sourceMapCache[position.source]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>retrieve source map</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> sourceMap
    urlAndMap = retrieveSourceMap(position.source)
    <span class="hljs-keyword">if</span> urlAndMap
      sourceMap = sourceMapCache[position.source] =
        <span class="hljs-attribute">url</span>: urlAndMap.url
        <span class="hljs-attribute">map</span>: <span class="hljs-keyword">new</span> sourcemap.SourceMapConsumer(urlAndMap.map)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Resolve the source URL relative to the URL of the source map</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> sourceMap
    mapPosition = sourceMap.map.originalPositionFor position
    <span class="hljs-keyword">if</span> mapPosition.source
      mapPosition.source = supportRelativeURL path.dirname(position.source), mapPosition.source
      <span class="hljs-keyword">return</span> mapPosition
  <span class="hljs-literal">null</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-the-sourcemap-data">
  <h3>
    <a href="#get-the-sourcemap-data" name="get-the-sourcemap-data" class="pilcrow"></a>
Get the sourcemap data
  </h3>
</div>
<p>Takes a
generated source filename; returns a {map, optional url} object, or null if
there is no source map.  The map field may be either a string or the parsed
JSON object (ie, it must be a valid argument to the SourceMapConsumer
constructor).</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">retrieveSourceMap</span> = <span class="hljs-params">(source)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Get the URL of the source map</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  fileData = retrieveFile(source)
  match = <span class="hljs-regexp">/\/\/[#@]\s*sourceMappingURL=(.*)\s*$/m</span>.exec(fileData)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>  <span class="hljs-keyword">unless</span> match
  sourceMappingURL = match[<span class="hljs-number">1</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Read the contents of the source map</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  sourceMapData = <span class="hljs-literal">undefined</span>
  dataUrlPrefix = <span class="hljs-string">"data:application/json;base64,"</span>
  <span class="hljs-keyword">if</span> sourceMappingURL.slice(<span class="hljs-number">0</span>, dataUrlPrefix.length).toLowerCase() <span class="hljs-keyword">is</span> dataUrlPrefix
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Support source map URL as a data url</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    sourceMapData = <span class="hljs-keyword">new</span> Buffer(sourceMappingURL.slice(dataUrlPrefix.length), <span class="hljs-string">"base64"</span>).toString()
  <span class="hljs-keyword">else</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Support source map URLs relative to the source URL</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    dir = path.dirname(source)
    sourceMappingURL = supportRelativeURL(dir, sourceMappingURL)
    sourceMapData = retrieveFile(sourceMappingURL, <span class="hljs-string">"utf8"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>  <span class="hljs-keyword">unless</span> sourceMapData
  <span class="hljs-attribute">url</span>: sourceMappingURL
  <span class="hljs-attribute">map</span>: sourceMapData

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Maps a file path to a source map for that file</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">isInBrowser</span> = -&gt;</span> <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">"undefined"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="retrieve-file-for-node-and-browser">
  <h3>
    <a href="#retrieve-file-for-node-and-browser" name="retrieve-file-for-node-and-browser" class="pilcrow"></a>
Retrieve file for node and browser
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">retrieveFile</span> = <span class="hljs-params">(path)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> fileContentsCache[path]  <span class="hljs-keyword">if</span> path <span class="hljs-keyword">of</span> fileContentsCache
  <span class="hljs-keyword">try</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Use AJAX if we are in the browser</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> isInBrowser()
      xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()
      xhr.open <span class="hljs-string">"GET"</span>, path, <span class="hljs-literal">false</span>
      xhr.send <span class="hljs-literal">null</span>
      contents = (<span class="hljs-keyword">if</span> xhr.readyState <span class="hljs-keyword">is</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> xhr.responseText <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Otherwise, use the file system</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">else</span>
      contents = fs.readFileSync path, <span class="hljs-string">"utf8"</span>
  <span class="hljs-keyword">catch</span> ex
    contents = <span class="hljs-literal">null</span>
  fileContentsCache[path] = contents
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>Maps a file path to a string containing the file contents</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">fileContentsCache = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="make-path-absolute">
  <h3>
    <a href="#make-path-absolute" name="make-path-absolute" class="pilcrow"></a>
Make path absolute
  </h3>
</div>
<p>Support URLs relative to a directory, but be careful about a protocol prefix
in case we are in the browser (i.e. directories may start with &quot;http://&quot;)</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">supportRelativeURL</span> = <span class="hljs-params">(dir, url)</span> -&gt;</span>
  match = <span class="hljs-regexp">/^\w+:\/\/[^\/]*/</span>.exec(dir)
  protocol = (<span class="hljs-keyword">if</span> match <span class="hljs-keyword">then</span> match[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>)
  protocol + path.resolve dir.slice(protocol.length), url

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-eval-origin">
  <h3>
    <a href="#get-eval-origin" name="get-eval-origin" class="pilcrow"></a>
get eval origin
  </h3>
</div>
<p>Parses code generated by FormatEvalOrigin(), a function inside V8:
https://code.google.com/p/v8/source/browse/trunk/src/messages.js</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">mapEvalOrigin</span> = <span class="hljs-params">(origin)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>Most eval() calls are in this format</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  match = <span class="hljs-regexp">/^eval at ([^(]+) \((.+):(\d+):(\d+)\)$/</span>.exec(origin)
  <span class="hljs-keyword">if</span> match
    position = mapSourcePosition(
      <span class="hljs-attribute">source</span>: match[<span class="hljs-number">2</span>]
      <span class="hljs-attribute">line</span>: match[<span class="hljs-number">3</span>]
      <span class="hljs-attribute">column</span>: match[<span class="hljs-number">4</span>]
    )
    <span class="hljs-keyword">return</span> <span class="hljs-string">"eval at <span class="hljs-subst">#{match[<span class="hljs-number">1</span>]}</span> (<span class="hljs-subst">#{position.source}</span>:<span class="hljs-subst">#{position.line}</span>:<span class="hljs-subst">#{position.column}</span>)"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>Parse nested eval() calls using recursion</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  match = <span class="hljs-regexp">/^eval at ([^(]+) \((.+)\)$/</span>.exec(origin)
  <span class="hljs-keyword">return</span> <span class="hljs-string">"eval at "</span> + match[<span class="hljs-number">1</span>] + <span class="hljs-string">" ("</span> + mapEvalOrigin(match[<span class="hljs-number">2</span>]) + <span class="hljs-string">")"</span>  <span class="hljs-keyword">if</span> match
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>Make sure we still return useful information if we didn't find anything</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  origin

install()

<span class="hljs-built_in">module</span>.exports.install = <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"DEPRECATED call to alinex-error.install() no longer needed"</span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
